<!DOCTYPE html>
<html>
  <head>
    <title>MISA&#43;&#43; Framework</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2019-11-03T23:08:31 CET">
<title>Creating caches :: MISA&#43;&#43; Framework</title>
<link rel="shortcut icon" href="../../../images/favicon.png" type="image/x-icon" />
<link href="../../../css/font-awesome.min.css" rel="stylesheet">
<link href="../../../css/nucleus.css" rel="stylesheet">
<link href="../../../theme-flex/style.css" rel="stylesheet">

<link rel="stylesheet" href="../../../css/bootstrap.min.css">
<script src="../../../js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "https:\/\/applied-systems-biology.github.io\/misa-framework\/";
</script>
<link rel="stylesheet" href="../../../css/custom.css">


    
  </head>
  <body data-url="/cpp-framework/development/creating-caches/">
    
      <header>
  <div class="logo">
    
	
  
    <a href="../../../" target="_self"><img src="../../../img/logo.svg" /></a><span style="font-size: 80%;">by <a href="https://www.leibniz-hki.de/en/applied-systems-biology.html" target="_blank">Applied Systems Biology, HKI Jena, Germany</a></span>

  


  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
    <nav class="shortcuts">
            <li class="" role="">
                <a href="../../../download"  rel="noopener">
                  <i class='fa fa-cloud-download'></i> <label>Download</label>
                </a>
            </li>
            <li class="" role="">
                <a href="../../../citation"  rel="noopener">
                  <i class='fa fa-paragraph'></i> <label>Citation</label>
                </a>
            </li>
    </nav>
</header>
<article>
  <aside>
    <ul class="menu">
          <li data-nav-id="/" class="dd-item">
          <a href="../../../">
            <i class="fa fa-fw fa-home"></i>
          </a>
          </li>
    <li data-nav-id="/imagej/" class="dd-item haschildren
        ">
      <div>
      <a href="../../../imagej/">ImageJ plugin</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/imagej/installation/" class="dd-item">
        <div>
          <a href="../../../imagej/installation/">
            Installation
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/imagej/step-by-step/" class="dd-item">
        <div>
          <a href="../../../imagej/step-by-step/">
            Tutorial: Step by step analysis
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/imagej/module-manager/" class="dd-item">
        <div>
          <a href="../../../imagej/module-manager/">
            Managing applications
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/imagej/analyzing-data/" class="dd-item">
        <div>
          <a href="../../../imagej/analyzing-data/">
            Analyzing data
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/imagej/creating-pipelines/" class="dd-item">
        <div>
          <a href="../../../imagej/creating-pipelines/">
            Creating pipelines
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
    <li data-nav-id="/imagej/result-analyzer/" class="dd-item haschildren
        ">
      <div>
      <a href="../../../imagej/result-analyzer/">Analyzing results</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/imagej/result-analyzer/output-data/" class="dd-item">
        <div>
          <a href="../../../imagej/result-analyzer/output-data/">
            Evaluating output data
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/imagej/result-analyzer/quantification-results/" class="dd-item">
        <div>
          <a href="../../../imagej/result-analyzer/quantification-results/">
            Browsing quantification results
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/imagej/result-analyzer/table-analyzer/" class="dd-item">
        <div>
          <a href="../../../imagej/result-analyzer/table-analyzer/">
            Summarizing quantification results
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/imagej/result-analyzer/plot-builder/" class="dd-item">
        <div>
          <a href="../../../imagej/result-analyzer/plot-builder/">
            Creating plots
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/imagej/result-analyzer/runtime-log/" class="dd-item">
        <div>
          <a href="../../../imagej/result-analyzer/runtime-log/">
            Analyzing the runtime
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
      <li data-nav-id="/imagej/credits/" class="dd-item">
        <div>
          <a href="../../../imagej/credits/">
            Credits
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/cpp-framework/" class="dd-item parent haschildren
        ">
      <div>
      <a href="../../../cpp-framework/">C&#43;&#43; Framework</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/cpp-framework/building/" class="dd-item haschildren
        ">
      <div>
      <a href="../../../cpp-framework/building/">Building</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/cpp-framework/building/building-linux/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/building/building-linux/">
            Building on Linux
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/building/windows-cygwin/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/building/windows-cygwin/">
            Building on Windows Cygwin
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/building/windows-msys2/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/building/windows-msys2/">
            Building on Windows MSYS2
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
      <li data-nav-id="/cpp-framework/running/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/running/">
            Running
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
    <li data-nav-id="/cpp-framework/development/" class="dd-item parent haschildren
        ">
      <div>
      <a href="../../../cpp-framework/development/">Development</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/cpp-framework/development/prerequisites/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/development/prerequisites/">
            Prerequisites
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/development/development-environment/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/development/development-environment/">
            Setting up a project
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/development/declaring-data/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/development/declaring-data/">
            Declaring data
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/development/creating-tasks/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/development/creating-tasks/">
            Creating tasks
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/development/creating-dispatchers/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/development/creating-dispatchers/">
            Creating dispatchers
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/development/dispatching-submodules/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/development/dispatching-submodules/">
            Dispatching submodules
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/development/attaching-data/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/development/attaching-data/">
            Attaching data
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/development/creating-caches/" class="dd-item active">
        <div>
          <a href="../../../cpp-framework/development/creating-caches/">
            Creating caches
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/development/tips/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/development/tips/">
            Tips and tricks
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/cpp-framework/standards/" class="dd-item haschildren
        ">
      <div>
      <a href="../../../cpp-framework/standards/">Standards</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/cpp-framework/standards/attachments/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/standards/attachments/">
            Attachments
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/standards/module-info/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/standards/module-info/">
            Module info
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/standards/parameter-schema/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/standards/parameter-schema/">
            Parameter schema
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/standards/parameters/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/standards/parameters/">
            Parameters
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/standards/public-api/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/standards/public-api/">
            Public API
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/standards/output-data/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/standards/output-data/">
            Result folder
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/standards/runtime-log/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/standards/runtime-log/">
            Runtime log
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/standards/serialization-id/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/standards/serialization-id/">
            Serialization ID
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
      <li data-nav-id="/cpp-framework/glossary/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/glossary/">
            Glossary
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/references/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/references/">
            Class reference
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cpp-framework/credits/" class="dd-item">
        <div>
          <a href="../../../cpp-framework/credits/">
            Credits
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/download/" class="dd-item
        ">
      <div>
      <a href="../../../download/">Download</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>
    <li data-nav-id="/citation/" class="dd-item
        ">
      <div>
      <a href="../../../citation/">Citation</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>




    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/imagej/" >
   ImageJ plugin</option>
    <option value="/cpp-framework/" >
   C&#43;&#43; Framework</option> 
    <option value="/cpp-framework/building/" >
  - 
   Building</option>
      <option value="/cpp-framework/running/" >- Running</option>
    <option value="/cpp-framework/development/" >
  - 
   Development</option> 
      <option value="/cpp-framework/development/prerequisites/" >-- Prerequisites</option>
      <option value="/cpp-framework/development/development-environment/" >-- Setting up a project</option>
      <option value="/cpp-framework/development/declaring-data/" >-- Declaring data</option>
      <option value="/cpp-framework/development/creating-tasks/" >-- Creating tasks</option>
      <option value="/cpp-framework/development/creating-dispatchers/" >-- Creating dispatchers</option>
      <option value="/cpp-framework/development/dispatching-submodules/" >-- Dispatching submodules</option>
      <option value="/cpp-framework/development/attaching-data/" >-- Attaching data</option>
      <option value="/cpp-framework/development/creating-caches/"  selected>-- Creating caches</option>
      <option value="/cpp-framework/development/tips/" >-- Tips and tricks</option>
  
    <option value="/cpp-framework/standards/" >
  - 
   Standards</option>
      <option value="/cpp-framework/glossary/" >- Glossary</option>
      <option value="/cpp-framework/references/" >- Class reference</option>
      <option value="/cpp-framework/credits/" >- Credits</option>
  
    <option value="/download/" >
   Download</option>
    <option value="/citation/" >
   Citation</option>



        </select>
      </center>
    </div>
      <div>
        <div class="searchbox">
          <input data-search-input id="search-by" type="text" placeholder="Search...">
        </div>
        <script type="text/javascript" src="../../../js/lunr.min.js"></script>
        <script type="text/javascript" src="../../../js/auto-complete.js"></script>
        <link href="../../../css/auto-complete.css" rel="stylesheet">
        <script type="text/javascript">
          
              var baseurl = "https:\/\/applied-systems-biology.github.io\/misa-framework\/";
          
        </script>
        <script type="text/javascript" src="../../../js/search.js"></script>
      </div>
    

    <h1>Creating caches</h1>
    
    
    
    

<p>This guide will show you how to create your own cache types. A cache data type consists of four different classes:</p>

<ul>
<li>The cache implementation</li>
<li>The cache accessor</li>
<li>A pattern</li>
<li>A description</li>
</ul>

<p>The cache implementation is responsible for dynamically loading and unloading data from/to a folder that is located within the filesystem. Such a folder on the other hand can contain many different files with different names, while an image file cache would for example look for a specific image file within this folder.</p>

<p>Instead of cache-specific functions like a <code>set_file(path)</code> function, a <em>description</em>
is used as input of a cache. It uses this description to set all internal parameters to function correctly. Descriptions are serializable, making them portable. The <code>describe()</code> function of a cache allows access to this description and implementation-independent modification of its values. This enables easy derivation of exported data from imported data.</p>

<p>A description on the other hand just contains already defined parameters (like for example the filename), which does not solve the issue of caches containing vastly different files. <em>Patterns</em> are objects with the purpose of creating a description from its a folder in a filesystem.</p>

<p>A cache <em>accessor</em> is a shared-pointer-like object with the purpose of allowing easy access to the functionality of a cache. You can use it to add convenient methods that make it easier to work with the specific cache type.</p>

<div class="notices info" >
The module interface and workers access a cache only via a cache accessor.
</div>

<link href="../../../mermaid/mermaid.css" type="text/css" rel="stylesheet"/>
<script defer src="../../../mermaid/mermaid.js">mermaid.initialize({startOnLoad:true});</script>
<div class="mermaid" align="center" >
graph TD;
Pattern-->|Produce|Description
Description-->|Link|Cache
Cache-->|Describe|Description
Filesystem-->|Produce|Description
Accessor-->|Access|Cache
Accessor-.-I["Module interface"]
</div>

<p>The base types of the necessary cache components are:</p>

<ul>
<li><code>misaxx::misa_cache</code> and any of <code>misaxx::utils::access::cache</code> for caches</li>
<li><code>misaxx::misa_cached_data</code> for accessors</li>
<li><code>misaxx::misa_data_pattern</code> for patterns</li>
<li><code>misaxx::misa_data_description</code> for desciptions</li>
</ul>

<h1 id="creating-the-cache-implementation">Creating the cache implementation</h1>

<p>We first show you to use our <code>misaxx::misa_default_cache</code> helper that automates many functions that you would need to define manually.</p>

<p>The <code>misaxx::misa_default_cache</code> helper requires three template arguments:</p>

<ul>
<li>A mutexed cache of type <code>misaxx::utils::access::cache</code> or <code>misaxx::utils::access::memory_cache</code></li>
<li>The pattern type</li>
<li>The description type</li>
</ul>

<blockquote>
<p>Please make sure to create a cache-specific description type. This is needed to later identify the cache type. Optional for the pattern type.</p>
</blockquote>

<p>The <em>mutexed cache</em> is a utility type that models the actual read and write access of the cache implementation. If you create a cache with a small enough footprint that allows it to be stored within memory, you can use <code>misaxx::utils::access::memory_cache</code> instead.</p>

<h2 id="linking-simulating-and-postprocessing">Linking, Simulating and Postprocessing</h2>

<p>The <code>misaxx::misa_default_cache</code> requires you to override following functions:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Description</span> <span style="color:#75af00">produce_description</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">boost</span><span style="color:#f92672">::</span><span style="color:#111">filesystem</span><span style="color:#f92672">::</span><span style="color:#111">path</span> <span style="color:#f92672">&amp;</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#111">Pattern</span> <span style="color:#f92672">&amp;</span><span style="color:#111">);</span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">do_link</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#f92672">&lt;</span><span style="color:#111">Description</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&amp;</span><span style="color:#111">t_description</span><span style="color:#111">);</span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">simulate_link</span><span style="color:#111">();</span> <span style="color:#75715e">// Optional
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#111">postprocess</span><span style="color:#111">()</span> <span style="color:#75715e">// Optional
</span></code></pre></div>
<p>The <code>produce_description()</code> function is responsible for creating applying the pattern and generating a description that allows the link function to find all necessary data within the folder.</p>

<p>The main link function is <code>do_link()</code>. It takes the description type of the cache and allows you to setup all internal functionality to make reading and writing work. It is only called if the runtime is not creating a parameter schema.</p>

<p>If a parameter schema is created, <code>simulate_link()</code> is called instead. By default, it will ensure that <code>describe()</code> returns a storage that contains both the pattern and description type. If you want to add additional information, just override this method.</p>

<h3 id="example">Example</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// The parameter schema will have the information that the pattern looks for JSON files
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#111">my_cache</span><span style="color:#f92672">::</span><span style="color:#111">simulate_link</span><span style="color:#111">()</span> <span style="color:#111">{</span>
    <span style="color:#111">describe</span><span style="color:#111">()</span><span style="color:#f92672">-&gt;</span><span style="color:#111">set</span><span style="color:#111">(</span><span style="color:#111">misa_file_pattern</span><span style="color:#111">({</span> <span style="color:#d88200">&#34;.json&#34;</span> <span style="color:#111">}));</span>
    <span style="color:#111">describe</span><span style="color:#111">()</span><span style="color:#f92672">-&gt;</span><span style="color:#111">access</span><span style="color:#f92672">&lt;</span><span style="color:#111">misa_file_description</span><span style="color:#f92672">&gt;</span><span style="color:#111">();</span>
<span style="color:#111">}</span>
</code></pre></div>
<h3 id="postprocessing">Postprocessing</h3>

<p>The <code>postprocess()</code> method will be called after the runtime has finished all tasks you can use it to clean up the cache or finalize the output.</p>

<h2 id="location-and-unique-location">Location and unique location</h2>

<p>A cache always has a <em>location</em> that corresponds to the location provided in the link function. It is automatically set by the default cache.</p>

<p>Additionally, there is an <em>unique location</em> that should always point to some file within the cache&rsquo;s location folder (use <code>get_location()</code> to obtain it). <strong>Please do not forget to set this unique location using set_unique_location() somewhere in do_link()</strong></p>

<h2 id="sub-caches">Sub-caches</h2>

<p>You can define sub-caches that are manually linked during <code>do_link()</code>. Just make sure that their location is equal to the location of the main cache and that their <strong>unique</strong> location is unique.</p>

<h2 id="thread-safe-data-access">Thread-safe data access</h2>

<p>A cache implementation always inherits from a mutexed cache of type <code>misaxx::utils::access::cache</code>. It will require you to override following methods as well:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">T</span> <span style="color:#f92672">&amp;</span><span style="color:#111">get</span><span style="color:#111">()</span> <span style="color:#00a8c8">override</span><span style="color:#111">;</span>
<span style="color:#00a8c8">const</span> <span style="color:#111">T</span> <span style="color:#f92672">&amp;</span><span style="color:#111">get</span><span style="color:#111">()</span> <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">override</span><span style="color:#111">;</span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">set</span><span style="color:#111">(</span><span style="color:#111">T</span> <span style="color:#111">value</span><span style="color:#111">)</span> <span style="color:#00a8c8">override</span><span style="color:#111">;</span>
<span style="color:#00a8c8">bool</span> <span style="color:#75af00">has</span><span style="color:#111">()</span> <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">override</span><span style="color:#111">;</span>
<span style="color:#00a8c8">bool</span> <span style="color:#75af00">can_pull</span><span style="color:#111">()</span> <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">override</span><span style="color:#111">;</span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">pull</span><span style="color:#111">()</span> <span style="color:#00a8c8">override</span><span style="color:#111">;</span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">stash</span><span style="color:#111">()</span> <span style="color:#00a8c8">override</span><span style="color:#111">;</span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">push</span><span style="color:#111">()</span> <span style="color:#00a8c8">override</span><span style="color:#111">;</span>
</code></pre></div>
<p>The get and set functions do what you would expect. <code>pull()</code> is responsible for loading data into memory, while <code>push()</code> is responsible for writing the current data to files on the harddrive. <code>push()</code> should <strong>not</strong> clear the data. <code>stash()</code> will be called to do only this if necessary. <code>can_pull()</code> should return if loading is possible (e.g. if the file exists).</p>

<p>All methods are called from a thread-safe environment using a shared mutex:</p>

<table>
<thead>
<tr>
<th>Function</th>
<th>Access</th>
</tr>
</thead>

<tbody>
<tr>
<td>get</td>
<td>shared</td>
</tr>

<tr>
<td>has</td>
<td>shared</td>
</tr>

<tr>
<td>can_pull</td>
<td>shared</td>
</tr>

<tr>
<td>pull</td>
<td>exclusive</td>
</tr>

<tr>
<td>stash</td>
<td>exclusive</td>
</tr>

<tr>
<td>push</td>
<td>exclusive</td>
</tr>
</tbody>
</table>

<div class="notices warning" >
Do not call `get()`, `has()`, etc. manually unless you know exactly what you do.
Use `readonly_access()`, `write_access()` and `readwrite_access()` that are provided by the accessor!
</div>

<h2 id="the-cache-accessor">The cache accessor</h2>

<p>A cache accessor is a shared pointer to a cache implementation. It contains additional functions to interact with the cache.</p>

<p>Just inherit from <code>misa_cached_data&lt;CacheImplementation&gt;</code>. You can also inherit from <code>misa_description_accessors_from_cache&lt;CacheImplementation, SELF&gt;</code> to automatically add convenient access to caches that are based on <code>misa_default_cache</code>.</p>

<div class="panel panel-default">
    <div class="panel-heading">Example</div>
    <div class="panel-body">

We will create a cache that provides access to an integer. It will be stored in a file, so it is sufficient to just use a file pattern and derive our description from misa_file_description.

### The pattern

```cpp
/**
patterns/integer_pattern.h
*/

struct integer_pattern : public misaxx::misa_file_pattern {
  // We only look for .integer files
  integer_description() : misaxx::misa_file_pattern({ ".integer" }) {

  }
protected:
      void build_serialization_id_hierarchy(std::vector<misa_serialization_id> &result) const override;
}

inline void to_json(nlohmann::json& j, const integer_pattern& p);
inline void from_json(const nlohmann::json& j, integer_pattern& p);
```

### The description

```cpp
/**
descriptions/integer_description.h
*/

struct integer_description : public misaxx::misa_file_description {
  using misa_file_description::misa_file_description;
protected:
      void build_serialization_id_hierarchy(std::vector<misa_serialization_id> &result) const override;
}

inline void to_json(nlohmann::json& j, const integer_description& p);
inline void from_json(const nlohmann::json& j, integer_description& p);

```

### The cache implementation

```cpp
/**
caches/integer_cache.h
*/

struct integer_cache : public misaxx::misa_default_cache<
  misaxx::utils::access::cache<int>,
  integer_pattern,
  integer_description> {

    // Inherited from mutexed cache. Just plain I/O
    int &get() { return m_value.get(); }

    const int &get() const { return m_value.get(); }

    void set(int v) { m_value = v; }

    bool has() const { return m_value.has_value(); }

    bool can_pull() const { return boost::filesystem::exists(m_path); }

    void stash() { m_value = std::nullopt; }

    void pull() {
      std::ifstream r;
      r.open(m_path.string());
      int v;
      r >> v;
      m_value = v;
    }

    void push() {
      std::ofstream w;
      w.open(m_path.string())
      w << m_value.get();
    }

    // Linkage, simulation & postprocessing
protected:

    integer_description produce_description(const boost::filesystem::path &path, const integer_pattern &pattern) override {
      integer_description description;
      pattern.apply(description, path); // Functionality of misa_file_pattern
      return description;
    }

public:

    void do_link(const integer_description &description) override {
      // Just take the filename in this case
      m_path = get_location() / description.filename;

      // VERY IMPORTANT
      set_unique_location(m_path);
    }

    void postprocess() override {
      std::cout << "Nothing" << "\n";
    }

private:
    boost::filesystem::path m_path;
    std::optional<int> m_value;
}
```

### Cache accessor

```cpp
/**
accessors/integer.h
*/

struct integer : public misaxx::misa_cached_data<integer_cache> {
  using misaxx::misa_cached_data<integer_cache>::misa_cached_data;

  // We add some additional functions for convenience
  int get() const {
    auto access = readonly_access();
    return access.get();
  }

  void set(int value) {
    auto access = write_access();
    access.set(value);
  }

}
```

</div>
    

<p></div></p>

<h1 id="sub-caches-1">Sub-caches</h1>

<p>You can create sub-caches that allow access to individual parts of the data. They live within the same filesystem location and are linked in the <code>do_link()</code> method of the main cache.</p>

<p>To make it easier, we provide the <code>misaxx::manual_cache</code> type that can be used as base instead of <code>misaxx::default_cache</code>. It provides the same functionality, but does not require a pattern. Instead, the main cache should provide a valid description.</p>

<p>In the <code>do_link()</code> method, create an uninitialized accessor type of the sub-cache and set its <code>data</code> attribute manually. Then run <code>force_link</code> with the appropriate arguments.
This will ensure that the sub-cache is registered correctly.</p>

<div class="panel panel-default">
    <div class="panel-heading">Example</div>
    <div class="panel-body">

```cpp
void do_link(integer_description &description) override {
  decimals accessor;
  accessor.data = std::make_shared<decimals_cache>();
  // Manual setup etc.

  // Important:
  decimal_description subcache_description;
  accessor.force_link(this->get_location(),
    misa_description_storage::with(subcache_description));

  // Store for later usage
  this->decimals = std::move(accessor);
}
```

</div>
    

<p></div></p>

<h1 id="without-using-misa-default-cache">Without using misa_default_cache</h1>

<p>A cache implementation should inherit from <code>misaxx::misa_cache</code> <strong>and</strong> a mutexed cache (<code>misaxx::utils::access::cache</code>). It should override following methods:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Main function that applies the linkage process:
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#75af00">link</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">boost</span><span style="color:#f92672">::</span><span style="color:#111">filesystem</span><span style="color:#f92672">::</span><span style="color:#111">path</span> <span style="color:#f92672">&amp;</span><span style="color:#111">t_location</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#111">std</span><span style="color:#f92672">::</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">misa_description_storage</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&amp;</span><span style="color:#111">t_description</span><span style="color:#111">);</span>

<span style="color:#75715e">// Returns the pattern &amp; description:
</span><span style="color:#75715e"></span><span style="color:#111">std</span><span style="color:#f92672">::</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">misa_description_storage</span><span style="color:#f92672">&gt;</span> <span style="color:#111">describe</span><span style="color:#111">()</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>

<span style="color:#75715e">// The absolute folder path where the data is located
</span><span style="color:#75715e"></span><span style="color:#111">boost</span><span style="color:#f92672">::</span><span style="color:#111">filesystem</span><span style="color:#f92672">::</span><span style="color:#111">path</span> <span style="color:#111">get_location</span><span style="color:#111">()</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>

<span style="color:#75715e">// A filename or any other unique file (for an explanation see below)
</span><span style="color:#75715e"></span><span style="color:#111">boost</span><span style="color:#f92672">::</span><span style="color:#111">filesystem</span><span style="color:#f92672">::</span><span style="color:#111">path</span> <span style="color:#111">get_unique_location</span><span style="color:#111">()</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>

<span style="color:#75715e">// Returns true if the cache has currently data
</span><span style="color:#75715e"></span><span style="color:#00a8c8">bool</span> <span style="color:#75af00">has_data</span><span style="color:#111">();</span>

<span style="color:#75715e">// Returns a &#34;self-description&#34; of the cache location
</span><span style="color:#75715e"></span><span style="color:#111">std</span><span style="color:#f92672">::</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">const</span> <span style="color:#111">misa_location</span><span style="color:#f92672">&gt;</span> <span style="color:#111">get_location_interface</span><span style="color:#111">()</span> <span style="color:#00a8c8">const</span>

<span style="color:#75715e">// Optionally: Run after all work is done
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#111">postprocess</span><span style="color:#111">()</span>

<span style="color:#75715e">// Additional methods might be necessary depending on the mutexed cache implementation
</span></code></pre></div>
<p>The <code>link()</code> method is provided with an absolute path within the filesystem and a description. The <code>link()</code> function is called independent of the <strong>simulation mode</strong>. This means you have to use <code>misaxx:runtime_properties::is_simulating()</code> to check if the runtime is actually processing data.</p>

<div class="notices warning" >
Please make sure that `describe()` **always** returns a non-empty description storage with **both a pattern and description**. This also applies for parameter schema generation.
</div>


    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="../../../cpp-framework/development/attaching-data/" title="Attaching data"> <i class="fa fa-chevron-left"></i><label>Attaching data</label></a>
    <a class="nav nav-next" href="../../../cpp-framework/development/tips/" title="Tips and tricks" style="margin-right: 0px;"><label>Tips and tricks</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    

    
    <div class="author">
        <i class='fa fa-user'></i> <a href="mailto:ruman.gerst@leibniz-hki.de">Ruman Gerst</a>
    </div>
    

    

    
  </div>


	<div>


  
    <p>By <a href="https://www.leibniz-hki.de/en/applied-systems-biology.html">Applied Systems Biology, Leibniz Institute for Natural Product Research and Infection Biology – Hans Knöll Institute (HKI), Jena, Germany</a></p>

  



	</div>
</footer>

<script src="../../../js/clipboard.min.js"></script>

<link href="../../../css/featherlight.min.css" rel="stylesheet">
<script src="../../../js/featherlight.min.js"></script>



<script src="../../../theme-flex/script.js"></script>


    

    
    

    
  </body>
</html>